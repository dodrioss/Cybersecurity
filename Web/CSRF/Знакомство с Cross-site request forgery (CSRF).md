Подделка межсайтовых запросов (также известная как CSRF) - это уязвимость веб-безопасности, которая позволяет злоумышленнику побудить пользователей выполнять действия, которые они не собираются выполнять. Это позволяет злоумышленнику частично обойти одну и ту же политику происхождения, которая предназначена для предотвращения вмешательства разных веб-сайтов друг в друга.

## Как работает CSRF?

Для того чтобы CSRF-атака была возможна, должны быть соблюдены три ключевых условия:

- **Соответствующее действие.** В приложении есть действие, которое злоумышленник имеет основания инициировать. Это может быть привилегированное действие (например, изменение разрешений для других пользователей) или любое действие с данными, специфичными для пользователя (например, изменение собственного пароля пользователя).
- **Обработка сеансов на основе файлов cookie.** Выполнение действия подразумевает отправку одного или нескольких HTTP-запросов, а приложение использует исключительно сеансовые cookie-файлы для идентификации пользователя, сделавшего запросы. Другого механизма отслеживания сеансов или проверки запросов пользователей не существует.
- **Никаких непредсказуемых параметров запроса.** Запросы, выполняющие действие, не содержат параметров, значения которых злоумышленник не может определить или угадать. Например, при попытке заставить пользователя сменить пароль функция не уязвима, если злоумышленнику необходимо знать значение существующего пароля.

Например, предположим, что приложение содержит функцию, которая позволяет пользователю изменить адрес электронной почты в своей учетной записи. Когда пользователь выполняет это действие, он делает HTTP-запрос следующего вида:

```
`POST /email/change HTTP/1.1 Host: vulnerable-website.com Content-Type: application/x-www-form-urlencoded Content-Length: 30 Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE email=wiener@normal-user.com`
```

Это соответствует условиям, необходимым для CSRF:

- Действие по изменению адреса электронной почты в учетной записи пользователя представляет интерес для злоумышленника. После этого действия злоумышленник, как правило, сможет инициировать сброс пароля и получить полный контроль над учетной записью пользователя.
- Приложение использует сеансовый cookie-файл для определения того, какой пользователь отправил запрос. Других токенов или механизмов для отслеживания пользовательских сеансов не существует.
- Злоумышленник может легко определить значения параметров запроса, необходимые для выполнения действия.

При соблюдении этих условий злоумышленник может создать веб-страницу, содержащую следующий HTML-код:

`<html> <body> <form action="https://vulnerable-website.com/email/change" method="POST"> <input type="hidden" name="email" value="pwned@evil-user.net" /> </form> <script> document.forms[0].submit(); </script> </body> </html>`

Если пользователь-жертва посетит веб-страницу злоумышленника, произойдет следующее:

- Страница злоумышленника вызовет HTTP-запрос к уязвимому веб-сайту.
- Если пользователь вошел на уязвимый веб-сайт, его браузер автоматически включит его сеансовый cookie-файл в запрос (предполагая, что [Файлы cookie SameSite](https://portswigger.net/web-security/csrf#common-defences-against-csrf) не используются).
- Уязвимый веб-сайт обработает запрос обычным способом, сочтет его сделанным пользователем-жертвой и изменит его адрес электронной почты.

## Приколы от TryHackMe

- Злоумышленник уже знает формат запросов веб-приложения на выполнение той или иной задачи и отправляет пользователю вредоносную ссылку.
- Личность жертвы на веб-сайте проверяется, как правило, с помощью файлов cookie, которые автоматически передаются при каждом запросе домена и нажатии на ссылку, предоставленную злоумышленником. Это взаимодействие может быть щелчком мыши, наведением мыши или любым другим действием.
- Недостаточные меры безопасности не позволяют веб-приложению различать подлинные запросы пользователей и фальсифицированные.


